{"version":3,"file":"index.js","sources":["../../src/utils/index.ts","../../src/database/index.ts","../../src/index.ts"],"sourcesContent":["import Database from \"../database\"\n\n// 判断是否是一个对象\nexport const isObject = (obj: unknown) => typeof(obj) === 'object' && obj !== null\n\nexport function isKeywordInThis(key: string) {\n  const instance = new Database()\n  let keys = Object.keys(instance)\n\n  return keys.includes(key)\n}\n","import { isKeywordInThis, isObject } from \"../utils\";\n\ninterface DataType {\n  [props: string]: any\n}\n\n/**\n * Provide data warehouse for fino framework\n * @param { type }  - this is a backup\n */\nclass Database {\n  // Namespace of module data\n  public namespace: string = '';\n\n  // Database\n  public data: DataType = {};\n\n  // Cache data key that has been set up proxy;\n  public existingProxy: Array<string> = [];\n\n\n  /**\n   * Initialize the namespace of the currently activated project\n   * @param { string } - name namespace\n   */\n  init(spacename: string) {\n    if(!spacename) { throw new Error('请传入命名空间'); return }\n\n    // 重置上一个命名空间的状态\n    // this.reset()\n    this.namespace = spacename\n\n\n    // 从缓存中恢复数据\n    if(!this.data[spacename]) {\n      const dataString = window.localStorage.getItem(`finoData_${spacename}`)\n\n      const data = dataString && JSON.parse(dataString);\n\n      this.set(data, spacename)\n    }\n\n    if(!this.data.global) {\n      const dataString = window.localStorage.getItem(`finoData_global`)\n\n      const data = dataString && JSON.parse(dataString);\n\n      this.set({ ...data }, 'global')\n    }\n  }\n\n  /**\n   * set up reactive data\n   * @param { object } - data 用户需要设置的数据\n   * @param { string? } - namespace 命名空间\n   */\n  set(data: DataType, namespace?: string) {\n\n    if(namespace && isKeywordInThis(namespace)) {\n      console.error(`${namespace}是数据仓库的关键字，请更改命名空间`);\n      return\n    }\n\n    if(!isObject(data)) {\n      console.error(`设置的数据必须是一个对象`);\n      return\n    }\n\n    const currentSpace: string = namespace || this.namespace;\n\n    let initialData = this.data[currentSpace] || {};\n\n    // 设置数据\n    this.data[currentSpace] = Object.assign(initialData, data, {\n      _spacename: currentSpace\n    })\n\n    // 代理访问链\n    for(let key in data) {\n      this.proxyOfprototype(data, currentSpace, key)\n    }\n\n    // 代理内容\n    this.data[currentSpace] = this.proxyOfcontent(currentSpace);\n\n    this.synchronizeDataInCache(currentSpace)\n\n\n  }\n\n  /**\n   * Get the data of a module\n   * @param { string } - key 需要获取的数据的key值\n   * @param { string } - namespace 命名空间\n   */\n  get(key?: string, namespace?: string) {\n    // 如果key为空，返回所有数据\n    if(!key && namespace) {\n      return this.data[this.namespace]\n    }\n    // 如果不传第二个参数， 默认获取当前命名空间下面的数据\n    else if(key && !namespace && this.data[this.namespace] && this.data[this.namespace][key] !== undefined) {\n      return this.data[this.namespace][key]\n    }\n    // 如果穿了第二个参数， 那么获取相应命名空间下面的数据\n    else if(namespace && key && this.data[namespace]) {\n      return this.data[namespace][key]\n    }\n  }\n\n  /**\n   * Reset the data under the current namespace\n   */\n  clear() {\n    if(!this.data[this.namespace]) { return }\n\n    const keys = Object.keys(this.data[this.namespace]);\n\n    keys.forEach(key => {\n      if(key === 'spacename') { return }\n\n      delete (this as DataType)[key]\n    })\n\n    this.data[this.namespace] = null\n  }\n\n  /**\n   * Proxy access chain\n   * @param { object } - data 用户需要设置的数据\n   * @param { string } - namespace 命名空间\n   * @param { string } - key 数据的key\n   */\n  proxyOfprototype(data: DataType, namespace: string, key: string) {\n    if(key === '_spacename') { return }\n\n    const _namespace = namespace || this.namespace;\n\n    const sharePropertyDefinition = {\n\n      get: () => {\n        return this.data[_namespace][key]\n      },\n\n      set: (newvalue: unknown) => {\n        this.data[key] = newvalue\n        this.data[_namespace][key] = newvalue\n      },\n\n      enumerable: true,\n      configurable: true,\n    }\n\n    Object.defineProperty(this, key, sharePropertyDefinition)\n  }\n\n  /**\n   * Proxy data content\n   * @param { string } - namespace 命名空间\n   */\n  proxyOfcontent(namespace: string): ProxyConstructor {\n    if(this.existingProxy.includes(namespace)) {\n      return this.data[namespace]\n    }\n\n    let proxy =  this.setProxy(this.data[namespace])\n\n    this.synchronizeDataInCache(namespace)\n\n\n    this.existingProxy.push(namespace)\n\n    return proxy\n  }\n\n  /**\n   * set data into cache - 将数据设置到缓存中， 一个是global的命名\b空间，一个是当前的命名空间\n   * @param { string } - namespace 命名空间\n   */\n  synchronizeDataInCache(namespace: string) {\n    const spaceData = this.data[namespace];\n\n    const globalData = this.data.global;\n\n    window.localStorage.setItem(`finoData_${namespace}`, JSON.stringify(spaceData))\n    window.localStorage.setItem(`finoData_global`, JSON.stringify(globalData));\n\n    // todo 后面会替换成npm包， 临时方案， 调用w\n    (window as any).$event && (window as any).$event.notify('dataChange')\n  }\n\n  setProxy(data: unknown) {\n    let proxy: ProxyConstructor = new Proxy(data, {\n      get: (target: any, key: string | number | symbol, receiver: any) => {\n\n        const res = Reflect.get(target, key, receiver);\n\n        return res\n      },\n      set: (target: any, key: string | number | symbol, value: any, receiver: any) => {\n        const oldValue = target[key]\n        if(target._spacename !== this.namespace && target._spacename !== 'global') {\n          console.error('不允许修改其他数据仓库的数据');\n          return oldValue\n        }\n        const result = Reflect.set(target, key, value, receiver);\n\n\n        return result\n      }\n    })\n\n    return proxy\n  }\n}\n\n\nexport default Database\n","\nimport Database from './database/index'\nconsole.log('databnase改变了最终版9')\nexport default Database\n\n"],"names":[],"mappings":"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"}